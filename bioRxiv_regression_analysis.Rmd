---
title: "Examining the citation and altmetric advantage of bioRxiv preprints: bioRxiv regression analysis"
output: html_notebook
---

# Here we conduct negative binomial regression between citation counts, 
# altmetrics and a number of explanatory variables


### Load libraries

```{r}

library(tidyverse)
library(lubridate)

```

### Summary Dataset

Data from various extracted data sets is aggregated into a single summary dataframe:
- Article metadata
- Impact factors
- OA status
- Author countries
- Author academic age
- Gender

```{r}

summary <- read_csv("data/articles.csv") %>%
  select(PREPRINT_DOI, ARTICLE_DOI, ARTICLE_CREATED_DATE,
         SOURCETITLE, DOCTYPE, AUTHOR_CNT, TYPE) %>%
  mutate(
    IS_DEPOSITED = case_when(
      TYPE == "Deposited" ~ 1,
      TYPE == "Control" ~ 0
    )
  ) %>%
  # is the article a review article?
  mutate(
    IS_REVIEW = case_when(
      DOCTYPE == 're' ~ 1,
      DOCTYPE == 'ar' ~ 0
    )
  ) %>%
  select(-DOCTYPE) %>%
  # join IF data
  mutate(YEAR = as.numeric(format(ARTICLE_CREATED_DATE, "%Y"))) %>%
  left_join(., read_csv("data/impact_factors.csv"),
             by=c("SOURCETITLE", "YEAR")) %>%
  select(-YEAR) %>%
  # where no IF given (e.g. in recently launched journals), set IF = 0
  mutate(IF = replace_na(IF, 0)) %>%
  # join OA status
  inner_join(., read_csv("data/article_oa_status.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  select(-JOURNAL_IS_OA) %>%
  mutate(IS_OA = as.numeric(IS_OA)) %>%
  # join first author countries
  left_join(., read_csv("data/first_author_countries.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  mutate(
    FIRST_AUTHOR_IS_US = case_when(
      COUNTRYCODE == 'USA' ~ 1,
      COUNTRYCODE != 'USA' ~ 0,
      is.na(COUNTRYCODE) ~ 0
    )
  ) %>%
  group_by(PREPRINT_DOI, ARTICLE_DOI) %>%
  arrange(desc(FIRST_AUTHOR_IS_US)) %>%
  top_n(1) %>%
  sample_n(1) %>%
  ungroup %>%
  select(-COUNTRYCODE) %>%
  # join last author countries
  left_join(., read_csv("data/last_author_countries.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  mutate(
    LAST_AUTHOR_IS_US = case_when(
      COUNTRYCODE == 'USA' ~ 1,
      COUNTRYCODE != 'USA' ~ 0,
      is.na(COUNTRYCODE) ~ 0
    )
  ) %>%
  group_by(PREPRINT_DOI, ARTICLE_DOI) %>%
  arrange(desc(LAST_AUTHOR_IS_US)) %>%
  top_n(1) %>%
  sample_n(1) %>%
  ungroup %>%
  select(-COUNTRYCODE) %>%
  # join academic age
  inner_join(., read_csv("data/first_author_age.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  rename(FIRST_AUTHOR_AGE = AUTHOR_AGE) %>%
  inner_join(., read_csv("data/last_author_age.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  rename(LAST_AUTHOR_AGE = AUTHOR_AGE) %>%
  # join gender
  inner_join(., read_csv("data/first_author_gender.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  mutate(
    FIRST_AUTHOR_IS_FEMALE = case_when(
      GENDER == 'female' ~ 1,
      GENDER == 'male' ~ 0
    )
  ) %>%
  select(-GENDER) %>%
  inner_join(., read_csv("data/last_author_gender.csv"),
             by=c("PREPRINT_DOI", "ARTICLE_DOI")) %>%
  mutate(
    LAST_AUTHOR_IS_FEMALE = case_when(
      GENDER == 'female' ~ 1,
      GENDER == 'male' ~ 0
    )
  ) %>%
  select(-GENDER) %>%
  # Remove missing values
  group_by(PREPRINT_DOI) %>% 
  filter(!any(is.na(FIRST_AUTHOR_IS_FEMALE)), 
         !any(is.na(LAST_AUTHOR_IS_FEMALE))) %>%
  ungroup()

```

### Regression analysis: 6-month citations

```{r}

article_6_month_citations <- read_csv("data/articles.csv") %>% 
  left_join(read_csv("data/citing_articles.csv"), 
            by=c("ARTICLE_DOI" = "CITED_ARTICLE_DOI")) %>%
  select(PREPRINT_DOI,
         ARTICLE_DOI, 
         ARTICLE_CREATED_DATE, 
         CITING_ARTICLE_CREATED_DATE, 
         TYPE) %>%
  mutate(
    CITED = case_when(
      is.na(CITING_ARTICLE_CREATED_DATE) ~ 0,
      !is.na(CITING_ARTICLE_CREATED_DATE) ~ 1
    ),
    CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                            "months"),
                                 floor_date(date(CITING_ARTICLE_CREATED_DATE), 
                                            "months")) %/% months(1),
    MAX_CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                                "months"),
                                     floor_date(date("2017-12-01"), 
                                                "months")) %/% months(1)) %>%
  complete(CITATION_INTERVAL, 
           nesting(PREPRINT_DOI, 
                   ARTICLE_DOI, 
                   ARTICLE_CREATED_DATE, 
                   CITING_ARTICLE_CREATED_DATE,
                   TYPE, 
                   MAX_CITATION_INTERVAL), 
           fill=list(CITED = 0)) %>%
  group_by(PREPRINT_DOI, ARTICLE_DOI, TYPE) %>%
  filter(MAX_CITATION_INTERVAL >= 6,
         CITATION_INTERVAL >= 0,
         CITATION_INTERVAL <= 6) %>%
  summarize(CITATION_CNT = sum(CITED)) %>%
  ungroup()

regression_data <- summary %>%
  inner_join(., article_6_month_citations,
             by=c("PREPRINT_DOI", "ARTICLE_DOI", "TYPE"))

library(QuantPsyc) # only load this when necessary - interferes with dplyr functionality
library(MASS)

# Citations
fit <- glm.nb(CITATION_CNT ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

summary(fit)
lm.beta(fit)

detach("package:QuantPsyc", unload=TRUE) # detach package
detach("package:MASS", unload=TRUE) # detach package

rm(regression_data, fit, article_6_month_citations)

```

### Regression analysis: 12-month citations

```{r}

article_12_month_citations <- read_csv("data/articles.csv") %>% 
  left_join(read_csv("data/citing_articles.csv"), 
            by=c("ARTICLE_DOI" = "CITED_ARTICLE_DOI")) %>%
  select(PREPRINT_DOI,
         ARTICLE_DOI, 
         ARTICLE_CREATED_DATE, 
         CITING_ARTICLE_CREATED_DATE, 
         TYPE) %>%
  mutate(
    CITED = case_when(
      is.na(CITING_ARTICLE_CREATED_DATE) ~ 0,
      !is.na(CITING_ARTICLE_CREATED_DATE) ~ 1
    ),
    CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                            "months"),
                                 floor_date(date(CITING_ARTICLE_CREATED_DATE), 
                                            "months")) %/% months(1),
    MAX_CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                                "months"),
                                     floor_date(date("2017-12-01"), 
                                                "months")) %/% months(1)) %>%
  complete(CITATION_INTERVAL, 
           nesting(PREPRINT_DOI, 
                   ARTICLE_DOI, 
                   ARTICLE_CREATED_DATE, 
                   CITING_ARTICLE_CREATED_DATE,
                   TYPE, 
                   MAX_CITATION_INTERVAL), 
           fill=list(CITED = 0)) %>%
  group_by(PREPRINT_DOI, ARTICLE_DOI, TYPE) %>%
  filter(MAX_CITATION_INTERVAL >= 12,
         CITATION_INTERVAL >= 0,
         CITATION_INTERVAL <= 12) %>%
  summarize(CITATION_CNT = sum(CITED)) %>%
  ungroup()

regression_data <- summary %>%
  inner_join(., article_12_month_citations,
             by=c("PREPRINT_DOI", "ARTICLE_DOI", "TYPE"))

library(QuantPsyc) # only load this when necessary - interferes with dplyr functionality
library(MASS)

# Citations
fit <- glm.nb(CITATION_CNT ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

summary(fit)
lm.beta(fit)

detach("package:QuantPsyc", unload=TRUE) # detach package
detach("package:MASS", unload=TRUE) # detach package

rm(regression_data, fit, article_12_month_citations)

```

### Regression analysis: 24-month citations

```{r}

article_24_month_citations <- read_csv("data/articles.csv") %>% 
  left_join(read_csv("data/citing_articles.csv"), 
            by=c("ARTICLE_DOI" = "CITED_ARTICLE_DOI")) %>%
  select(PREPRINT_DOI,
         ARTICLE_DOI, 
         ARTICLE_CREATED_DATE, 
         CITING_ARTICLE_CREATED_DATE, 
         TYPE) %>%
  mutate(
    CITED = case_when(
      is.na(CITING_ARTICLE_CREATED_DATE) ~ 0,
      !is.na(CITING_ARTICLE_CREATED_DATE) ~ 1
    ),
    CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                            "months"),
                                 floor_date(date(CITING_ARTICLE_CREATED_DATE), 
                                            "months")) %/% months(1),
    MAX_CITATION_INTERVAL = interval(floor_date(date(ARTICLE_CREATED_DATE), 
                                                "months"),
                                     floor_date(date("2017-12-01"), 
                                                "months")) %/% months(1)) %>%
  complete(CITATION_INTERVAL, 
           nesting(PREPRINT_DOI, 
                   ARTICLE_DOI, 
                   ARTICLE_CREATED_DATE, 
                   CITING_ARTICLE_CREATED_DATE,
                   TYPE, 
                   MAX_CITATION_INTERVAL), 
           fill=list(CITED = 0)) %>%
  group_by(PREPRINT_DOI, ARTICLE_DOI, TYPE) %>%
  filter(MAX_CITATION_INTERVAL >= 24,
         CITATION_INTERVAL >= 0,
         CITATION_INTERVAL <= 24) %>%
  summarize(CITATION_CNT = sum(CITED)) %>%
  ungroup()

regression_data <- summary %>%
  inner_join(., article_24_month_citations,
             by=c("PREPRINT_DOI", "ARTICLE_DOI", "TYPE"))

library(QuantPsyc) # only load this when necessary - interferes with dplyr functionality
library(MASS)

# Citations
fit <- glm.nb(CITATION_CNT ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

summary(fit)
lm.beta(fit)

detach("package:QuantPsyc", unload=TRUE) # detach package
detach("package:MASS", unload=TRUE) # detach package

rm(regression_data, fit, article_24_month_citations)

```

```{r}

regression_data <- summary %>%
# join altmetrics
  inner_join(., read_csv("data/article_altmetrics.csv"), 
             by=c("PREPRINT_DOI", "ARTICLE_DOI"))
  
library(QuantPsyc) # only load this when necessary - interferes with dplyr functionality
library(MASS)

# Citations
fit_tweets <- glm.nb(ALT_TWEETS ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

fit_feeds <- glm.nb(ALT_FEEDS ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

fit_msm <- glm.nb(ALT_MSM ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

fit_wikipedia <- glm.nb(ALT_WIKIPEDIA ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

fit_mendeley <- glm.nb(ALT_MENDELEY ~ IS_DEPOSITED + IF + IS_OA + AUTHOR_CNT + IS_REVIEW +
                FIRST_AUTHOR_IS_US + LAST_AUTHOR_IS_US + 
                FIRST_AUTHOR_AGE + LAST_AUTHOR_AGE + 
                FIRST_AUTHOR_IS_FEMALE + LAST_AUTHOR_IS_FEMALE, 
              data = regression_data, control=glm.control(maxit=50))

summary(fit_tweets)
lm.beta(fit_tweets)

summary(fit_feeds)
lm.beta(fit_feeds)

summary(fit_msm)
lm.beta(fit_msm)

summary(fit_wikipedia)
lm.beta(fit_wikipedia)

summary(fit_mendeley)
lm.beta(fit_mendeley)

detach("package:QuantPsyc", unload=TRUE) # detach package
detach("package:MASS", unload=TRUE) # detach package

rm(regression_data, fit)

```

